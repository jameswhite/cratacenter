---
layout: page
title: "pxe booting openbsd"
date: 2020-09-07 22:00:00 -0500
---

<p>Next we'll be talking about preparing the deployer platform for network OS installs. We've got some servers that need installing, some serial console cables run to them, a webpowerswitch, so we can hard-reset devices if needed.</p>
<p>The tech-tree for the programmatic-os-installs:</p>
<pre>
{% include capabilities/trees/programmatic-os-installs %}
</pre>

<p>The deployer node has both ethernet and wifi. The wifi will be on the same network segment as our workstation, and the ethernet will be it's own "install subnet" of <code>198.51.100.32/27</code>. This gives us 30 useable IPs, and will allow us to connect crates without collisions. Leave the routers and DNS servers out of the configuration. We want to use WiFi and our local subnet for those.</p>
<li>Create an <code>/etc/network/interfaces.d/eth0</code> file with the following contents</li>
<pre>
auto eth0
iface eth0 inet static
  address 198.51.100.33
  netmask 255.255.255.224
</pre>

<ul>
<li>I then reboot the deployer to ensure:</li>
<ul>
<li> the ip and netmask on eth0 are set </li>
<li> the default gateway and dns are still using wifi and the local area network</li>
</ul>
</ul>

<p>Now we can get things ready to install OpenBSD, we will need (as the technology tree illustrates):</p?
<ul>
<li>a DHCP server</li>
<pre>
apt-get install -y isc-dhcp-server
[ ! -f /etc/dhcp/dhcpd.conf.dist ] && cp /etc/dhcp/dhcpd.conf /etc/dhcp/dhcpd.conf.dist

# /etc/default/isc-dhcp-server
INTERFACESv4="eth0"
INTERFACESv6=""

# /etc/dhcp/dhcpd.conf
ddns-update-style none;
option domain-name "apartment.jameswhite.org";
option domain-name-servers 10.252.0.254 10.252.0.6, 10.252.0.7;
default-lease-time 600;
max-lease-time 7200;
log-facility local7;

subnet 10.252.0.0 netmask 255.255.255.0   { deny unknown-clients; }
subnet 198.51.100.0 netmask 255.255.255.0 { deny unknown-clients; }

[ -f /var/run/dhcpd.pid ] && rm -f /var/run/dhcpd.pid; service isc-dhcp-server start; journalctl -xe

</pre>

<li>a TFTP server</li>
<pre>
apt-get install -y tftpd-hpa
</pre>
<li>pxeboot files</li>
<pre>

</pre>
<li>a http server</li>
<pre>
apt-get install -y nginx
</pre>



<pre>
SeaBIOS (version rel-1.12.1.3-0-g300e8b70)

Press F10 key now for boot menu

Select boot device:

1. AHCI/0: SATA SSD ATA-11 Hard-Disk (57241 MiBytes)
2. Payload [setup]
3. Payload [memtest]
</pre>

<li>Press the &lt;F10&gt; key</li>
<details><summary>default boot order</summary>
<pre>
Boot order - type letter to move device to top.

  a USB
  b SDCARD
  c mSATA
  d SATA
  e mPCIe1 SATA1 and SATA2
  f iPXE (disabled)


  r Restore boot order defaults
  n Network/PXE boot - Currently Disabled
  u USB boot - Currently Enabled
  t Serial console - Currently Enabled
  k Redirect console output to COM2 - Currently Disabled
  o UART C - Currently Enabled
  p UART D - Currently Enabled
  m Force mPCIe2 slot CLK (GPP3 PCIe) - Currently Disabled
  h EHCI0 controller - Currently Disabled
  l Core Performance Boost - Currently Enabled
  i Watchdog - Currently Disabled
  j SD 3.0 mode - Currently Disabled
  v IOMMU - Currently Disabled
  y PCIe power management features - Currently Disabled
  w Enable BIOS write protect - Currently Disabled
  x Exit setup without save
  s Save configuration and exit
</pre>
</details>

<li>press the &lt;n&gt; key to enable iPXE</li>
<li>press the &lt;f&gt;&lt;a&gt;,and &lt;b&gt; keys, note pxe will now be enabled and the machine will try USB, then iPXE, then mSATA, then SDCard;<li>
<details><summary>new boot order</summary>
<pre>
Boot order - type letter to move device to top.

  a USB
  f iPXE
  c mSATA
  b SDCARD
  d SATA
  e mPCIe1 SATA1 and SATA2


  r Restore boot order defaults
  n Network/PXE boot - Currently Disabled
  u USB boot - Currently Enabled
  t Serial console - Currently Enabled
  k Redirect console output to COM2 - Currently Disabled
  o UART C - Currently Enabled
  p UART D - Currently Enabled
  m Force mPCIe2 slot CLK (GPP3 PCIe) - Currently Disabled
  h EHCI0 controller - Currently Disabled
  l Core Performance Boost - Currently Enabled
  i Watchdog - Currently Disabled
  j SD 3.0 mode - Currently Disabled
  v IOMMU - Currently Disabled
  y PCIe power management features - Currently Disabled
  w Enable BIOS write protect - Currently Disabled
  x Exit setup without save
  s Save configuration and exit
</pre>
</details>
<li>press the &lt;s&gt; key to enable iPXE</li>

<li>make a note of the mac addresses it tries. We'll be using net0 to pxe boot</li>
<pre>
net0: 00:0d:b9:57:17:14 using i211 on 0000:01:00.0 (open)
  [Link:up, TX:0 TXE:0 RX:0 RXE:0]
Configuring (net0 00:0d:b9:57:17:14)................. No configuration methods succeeded (http://ipxe.org/040ee119)
net1: 00:0d:b9:57:17:15 using i211 on 0000:02:00.0 (open)
  [Link:up, TX:0 TXE:0 RX:0 RXE:0]
Configuring (net1 00:0d:b9:57:17:15)................. No configuration methods succeeded (http://ipxe.org/040ee119)
net2: 00:0d:b9:57:17:16 using i211 on 0000:03:00.0 (open)
  [Link:up, TX:0 TXE:0 RX:0 RXE:0]
Configuring (net2 00:0d:b9:57:17:16)................. No configuration methods succeeded (http://ipxe.org/040ee119)
net3: 00:0d:b9:57:17:17 using i211 on 0000:03:00.0 (open)
  [Link:up, TX:0 TXE:0 RX:0 RXE:0]
Configuring (net3 00:0d:b9:57:17:17)................. No configuration methods succeeded (http://ipxe.org/040ee119)

Trying next device: 33
Trying next device: 4
Trying next device: 5
No bootable device.  Retrying in 60 seconds.
</pre>
